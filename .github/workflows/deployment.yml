name: Deployment
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["dev"]
jobs:
  deploy:
    runs-on: self-hosted
    if: github.event_name == 'push'
    steps:
      - name: Clone Repo ğŸ¤–
        uses: actions/checkout@v3

      - name: Set Environment Variables ğŸ” 
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          REDISHOST: ${{ secrets.REDISHOST }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "BACKEND_URL=$BACKEND_URL" >> .env
          echo "REDISHOST=$REDISHOST" >> .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env

      - name: Clear Cache ğŸ«§
        run: |
          docker stop real-time || true
          docker rm real-time || true
          docker rmi real-time-real-time:latest || true

      - name: Run Image âœ…
        run: |
          docker compose up -d

      - name: Message âœ‰ï¸
        uses: fjogeleit/http-request-action@v1
        with:
          timeout: 60000
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: "POST"
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"content": "CE PROJECT Real Time Build âœ…","embeds": [{"title": "Real Time URL","description": "https://codespace-realtime.srv-demo-2.home.unixvextor.com"}]}'
