name: Deployment
on:
  push:
      branches: ['main']
  pull_request:
      branches: ['dev']
jobs:
  deploy:
      runs-on: self-hosted
      if: github.event_name == 'push'
      steps:
          - name: Clone Repo ü§ñ
            uses: actions/checkout@v3

          - name: Set Environment Variables üî†
            env:
              BACKEND_URL: ${{ secrets.BACKEND_URL }} 
              REDISHOST: ${{ secrets.REDISHOST }}
              JWT_SECRET: ${{ secrets.JWT_SECRET }} 
            run:
              echo "BACKEND_URL=$BACKEND_URL" >> .env
              echo "REDISHOST=$REDISHOST" >> .env
              echo "JWT_SECRET=$JWT_SECRET" >> .env

          - name: Clear Cache ü´ß
            run: |
              docker stop real-time || true
              docker rm real-time || true
              docker rmi real-time-realtime:latest || true

          - name: Run Image ‚úÖ
            run: |
              docker compose up -d

          - name: Message ‚úâÔ∏è
            uses: fjogeleit/http-request-action@v1
            with:
              timeout: 60000
              url: ${{ secrets.DISCORD_WEBHOOK }}
              method: 'POST'
              customHeaders: '{"Content-Type": "application/json"}'
              data: '{"content": "CE PROJECT Real Time Build ‚úÖ","embeds": [{"title": "Real Time URL","description": "https://realtime-codespace.unixvextor.com"}]}'

